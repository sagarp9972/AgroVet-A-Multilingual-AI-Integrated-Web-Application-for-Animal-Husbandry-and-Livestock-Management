<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Disease Prediction</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #FAF3E0; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,.1); }
        h1 { background-color: #2C3E50; color: #fff; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-size: 2em; }
        p { line-height: 1.6; }
        form { background: #fff; margin: 15px 0; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
        input[type="file"] { margin-bottom: 10px; }
        button { background-color: #2980B9; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #1F618D; }
        h3 { color: #2980B9; }
        .error { color: #E74C3C; }
        .language-selector { position: absolute; top: 10px; right: 20px; z-index: 1000; }
        #camera-controls, #file-upload-controls { display: none; flex-direction: column; align-items: center; }
        #option-buttons { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        #video { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; background-color: #000; }
        #captured-image { width: 224px; height: 224px; border: 1px solid #ccc; border-radius: 5px; object-fit: contain; background-color: #f0f0f0; margin-top: 10px; display: none; }
        #canvas { display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-top: 16px; }
        .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); background: #fff; }
        .card img { width: 100%; height: auto; border-radius: 8px; }
        .muted { color: #666; font-size: 0.92em; }
    </style>
</head>
<body>
    <!-- Language Selector -->
    <div class="language-selector">
        <label for="language">Language:</label>
        <select id="language" onchange="changeLanguageViaBackend()">
            <option value="en" selected>English</option>
            <option value="kn">ಕನ್ನಡ</option>
            <option value="hi">हिंदी</option>
            <option value="ta">தமிழ்</option>
            <option value="te">తెలుగు</option>
        </select>
    </div>

    <div class="container">
        <h1>Animal Disease Prediction</h1>
        <p>Choose an option to upload an image of the animal to detect diseases and get preventive measures.</p>

        <!-- Upload / Camera Options -->
        <div id="option-buttons">
            <button id="show-camera" type="button">Take a Photo</button>
            <button id="show-upload" type="button">Upload a File</button>
        </div>

        <!-- Prediction Form -->
        <form id="prediction-form" method="POST" enctype="multipart/form-data" action="/disease-detection">
            <!-- Camera Controls -->
            <div id="camera-controls">
                <video id="video" autoplay></video>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="capture-photo" type="button">Capture Photo</button>
                    <button id="switch-camera" type="button" style="display:none;">Switch Camera</button>
                </div>
                <img id="captured-image" src="" alt="Captured Image">
            </div>

            <!-- File Upload -->
            <div id="file-upload-controls">
                <input type="file" name="file" id="file-input" accept="image/*">
            </div>

            <!-- Submit -->
            <button type="submit" id="predict-button" style="display: none;">Predict Disease</button>
        </form>

        <!-- Prediction Result -->
        {% if prediction %}
            <div class="card">
                <h3>Prediction</h3>
                <p><strong>{{ prediction }}</strong></p>
                <p>Confidence: <strong>{{ confidence }}</strong></p>
                {% if medication %}
                    <p class="muted">Suggested Care:</p>
                    <p>{{ medication }}</p>
                {% else %}
                    <p>No medication suggestion available for this condition.</p>
                {% endif %}
            </div>
        {% endif %}

        <!-- Input & Explainable AI Results -->
        {% if img_data %}
            <div class="grid">
                <div class="card">
                    <h3>Input (224×224)</h3>
                    <img src="data:image/png;base64,{{ img_data }}" alt="Uploaded Image">
                    <p class="muted">Shown exactly as the model saw it.</p>
                </div>
                {% if gradcam_heatmap_data %}
                <div class="card">
                    <h3>Grad-CAM Heatmap</h3>
                    <img src="data:image/png;base64,{{ gradcam_heatmap_data }}" alt="Grad-CAM Heatmap">
                    <p class="muted">Red/yellow = stronger influence.</p>
                </div>
                {% endif %}
                {% if gradcam_overlay_data %}
                <div class="card">
                    <h3>Grad-CAM Overlay</h3>
                    <img src="data:image/png;base64,{{ gradcam_overlay_data }}" alt="Grad-CAM Overlay">
                    <p class="muted">Heatmap blended with original image.</p>
                </div>
                {% endif %}
            </div>
        {% endif %}

        <!-- Error Display -->
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        <canvas id="canvas"></canvas>
    </div>

    <!-- JavaScript -->
    <script>
        function changeLanguageViaBackend() {
            const selectedLanguage = document.getElementById("language").value;
            window.location.href = `/set_language/${selectedLanguage}?next=${window.location.pathname}`;
        }

        const showCameraButton = document.getElementById('show-camera');
        const showUploadButton = document.getElementById('show-upload');
        const cameraControls = document.getElementById('camera-controls');
        const fileUploadControls = document.getElementById('file-upload-controls');
        const video = document.getElementById('video');
        const capturePhotoButton = document.getElementById('capture-photo');
        const switchCameraButton = document.getElementById('switch-camera');
        const capturedImage = document.getElementById('captured-image');
        const predictButton = document.getElementById('predict-button');
        const canvas = document.getElementById('canvas');
        const fileInput = document.getElementById('file-input');
        const context = canvas.getContext('2d');
        let currentStream;
        let facingMode = 'user';

        function resetControls() {
            cameraControls.style.display = 'none';
            fileUploadControls.style.display = 'none';
            predictButton.style.display = 'none';
            capturedImage.style.display = 'none';
            capturedImage.src = '';
            fileInput.value = null;
            switchCameraButton.style.display = 'none';
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                currentStream = null;
            }
        }

        async function startCamera() {
            resetControls();
            cameraControls.style.display = 'flex';
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode }, audio: false });
                video.srcObject = currentStream;
                video.style.display = 'block';
                capturePhotoButton.style.display = 'block';
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                if (videoDevices.length > 1) switchCameraButton.style.display = 'block';
            } catch (err) {
                console.error("Error accessing the camera: ", err);
                alert("Could not access camera. Please ensure you have a webcam and granted permissions.");
            }
        }

        showCameraButton.addEventListener('click', () => startCamera());

        switchCameraButton.addEventListener('click', () => {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            startCamera();
        });

        showUploadButton.addEventListener('click', () => {
            resetControls();
            fileUploadControls.style.display = 'flex';
            if (fileInput.files.length > 0) predictButton.style.display = 'block';
        });

        capturePhotoButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataURL = canvas.toDataURL('image/jpeg');
            capturedImage.src = imageDataURL;
            capturedImage.style.display = 'block';
            predictButton.style.display = 'block';
            video.style.display = 'none';
            capturePhotoButton.style.display = 'none';
            switchCameraButton.style.display = 'none';
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                predictButton.style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedImage.src = e.target.result;
                    capturedImage.style.display = 'block';
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                predictButton.style.display = 'none';
                capturedImage.style.display = 'none';
                capturedImage.src = '';
            }
        });

        document.getElementById('prediction-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData();
            let hasFile = false;

            if (capturedImage.src && capturedImage.style.display === 'block' && video.style.display === 'none') {
                try {
                    const response = await fetch(capturedImage.src);
                    const blob = await response.blob();
                    formData.append('file', blob, 'captured_image.jpeg');
                    hasFile = true;
                } catch (error) {
                    alert("Error preparing captured image for upload.");
                    console.error('Error fetching blob from captured image:', error);
                    return;
                }
            } else if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
                hasFile = true;
            }

            if (!hasFile) {
                alert("Please take a photo or select a file first.");
                return;
            }

            try {
                const response = await fetch(event.target.action, { method: event.target.method, body: formData });
                if (response.ok) {
                    const htmlResponse = await response.text();
                    document.querySelector('.container').innerHTML =
                        new DOMParser().parseFromString(htmlResponse, 'text/html').querySelector('.container').innerHTML;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    console.error('Server error:', response.status, await response.text());
                    alert("An error occurred during prediction.");
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert("An error occurred while connecting to the server.");
            }
        });

        document.addEventListener('DOMContentLoaded', () => { resetControls(); });
    </script>
</body>
</html>
